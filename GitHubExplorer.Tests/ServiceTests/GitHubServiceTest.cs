using GitHubExplorer.Models;
using GitHubExplorer.Service.Interfaces;
using Moq;
using NUnit.Framework;

namespace GitHubExplorer.Tests.GitHubService
{
    [TestFixture]
    public class GitHubServiceTest
    {
        private IService<GitHubRepository, GitHubCommitHistoryCollection> _iService;

        private Mock<IHttpWebClient> _mockWebClient;
        private Mock<IConfig> _mockConfig;
        private Mock<IJsonConverter> _mockConverter;

        [SetUp]
        public void SetUp()
        {
            _mockConverter = new Mock<IJsonConverter>();
            _mockWebClient = new Mock<IHttpWebClient>();
            _mockConfig = new Mock<IConfig>();
            _iService = new Service.GitHubService(_mockConfig.Object, _mockWebClient.Object, _mockConverter.Object);
        }

        // Behavioral testing to verifies deserialized repo
        [Test]
        public void Returns_DeserializedRepositories()
        {
            const string jsonRepositories = "{\n  \"total_count\": 12064,\n  \"incomplete_results\": false,\n  \"items\": [\n    {\n      \"id\": 8654975,\n      \"node_id\": \"MDEwOlJlcG9zaXRvcnk4NjU0OTc1\",\n      \"name\": \"PluralsightSpaJumpStartFinal\",\n      \"full_name\": \"johnpapa/PluralsightSpaJumpStartFinal\",\n      \"private\": false,\n      \"owner\": {\n        \"login\": \"johnpapa\",\n        \"id\": 1202528,\n        \"node_id\": \"MDQ6VXNlcjEyMDI1Mjg=\",\n        \"avatar_url\": \"https://avatars2.githubusercontent.com/u/1202528?v=4\",\n        \"gravatar_id\": \"\",\n        \"url\": \"https://api.github.com/users/johnpapa\",\n        \"html_url\": \"https://github.com/johnpapa\",\n        \"followers_url\": \"https://api.github.com/users/johnpapa/followers\",\n        \"following_url\": \"https://api.github.com/users/johnpapa/following{/other_user}\",\n        \"gists_url\": \"https://api.github.com/users/johnpapa/gists{/gist_id}\",\n        \"starred_url\": \"https://api.github.com/users/johnpapa/starred{/owner}{/repo}\",\n        \"subscriptions_url\": \"https://api.github.com/users/johnpapa/subscriptions\",\n        \"organizations_url\": \"https://api.github.com/users/johnpapa/orgs\",\n        \"repos_url\": \"https://api.github.com/users/johnpapa/repos\",\n        \"events_url\": \"https://api.github.com/users/johnpapa/events{/privacy}\",\n        \"received_events_url\": \"https://api.github.com/users/johnpapa/received_events\",\n        \"type\": \"User\",\n        \"site_admin\": false\n      },\n      \"html_url\": \"https://github.com/johnpapa/PluralsightSpaJumpStartFinal\",\n      \"description\": \"Source code for the SPA JumpStart Pluralsight course at http://jpapa.me/spajsps\",\n      \"fork\": false,\n      \"url\": \"https://api.github.com/repos/johnpapa/PluralsightSpaJumpStartFinal\",\n      \"forks_url\": \"https://api.github.com/repos/johnpapa/PluralsightSpaJumpStartFinal/forks\",\n      \"keys_url\": \"https://api.github.com/repos/johnpapa/PluralsightSpaJumpStartFinal/keys{/key_id}\",\n      \"collaborators_url\": \"https://api.github.com/repos/johnpapa/PluralsightSpaJumpStartFinal/collaborators{/collaborator}\",\n      \"teams_url\": \"https://api.github.com/repos/johnpapa/PluralsightSpaJumpStartFinal/teams\",\n      \"hooks_url\": \"https://api.github.com/repos/johnpapa/PluralsightSpaJumpStartFinal/hooks\",\n      \"issue_events_url\": \"https://api.github.com/repos/johnpapa/PluralsightSpaJumpStartFinal/issues/events{/number}\",\n      \"events_url\": \"https://api.github.com/repos/johnpapa/PluralsightSpaJumpStartFinal/events\",\n      \"assignees_url\": \"https://api.github.com/repos/johnpapa/PluralsightSpaJumpStartFinal/assignees{/user}\",\n      \"branches_url\": \"https://api.github.com/repos/johnpapa/PluralsightSpaJumpStartFinal/branches{/branch}\",\n      \"tags_url\": \"https://api.github.com/repos/johnpapa/PluralsightSpaJumpStartFinal/tags\",\n      \"blobs_url\": \"https://api.github.com/repos/johnpapa/PluralsightSpaJumpStartFinal/git/blobs{/sha}\",\n      \"git_tags_url\": \"https://api.github.com/repos/johnpapa/PluralsightSpaJumpStartFinal/git/tags{/sha}\",\n      \"git_refs_url\": \"https://api.github.com/repos/johnpapa/PluralsightSpaJumpStartFinal/git/refs{/sha}\",\n      \"trees_url\": \"https://api.github.com/repos/johnpapa/PluralsightSpaJumpStartFinal/git/trees{/sha}\",\n      \"statuses_url\": \"https://api.github.com/repos/johnpapa/PluralsightSpaJumpStartFinal/statuses/{sha}\",\n      \"languages_url\": \"https://api.github.com/repos/johnpapa/PluralsightSpaJumpStartFinal/languages\",\n      \"stargazers_url\": \"https://api.github.com/repos/johnpapa/PluralsightSpaJumpStartFinal/stargazers\",\n      \"contributors_url\": \"https://api.github.com/repos/johnpapa/PluralsightSpaJumpStartFinal/contributors\",\n      \"subscribers_url\": \"https://api.github.com/repos/johnpapa/PluralsightSpaJumpStartFinal/subscribers\",\n      \"subscription_url\": \"https://api.github.com/repos/johnpapa/PluralsightSpaJumpStartFinal/subscription\",\n      \"commits_url\": \"https://api.github.com/repos/johnpapa/PluralsightSpaJumpStartFinal/commits{/sha}\",\n      \"git_commits_url\": \"https://api.github.com/repos/johnpapa/PluralsightSpaJumpStartFinal/git/commits{/sha}\",\n      \"comments_url\": \"https://api.github.com/repos/johnpapa/PluralsightSpaJumpStartFinal/comments{/number}\",\n      \"issue_comment_url\": \"https://api.github.com/repos/johnpapa/PluralsightSpaJumpStartFinal/issues/comments{/number}\",\n      \"contents_url\": \"https://api.github.com/repos/johnpapa/PluralsightSpaJumpStartFinal/contents/{+path}\",\n      \"compare_url\": \"https://api.github.com/repos/johnpapa/PluralsightSpaJumpStartFinal/compare/{base}...{head}\",\n      \"merges_url\": \"https://api.github.com/repos/johnpapa/PluralsightSpaJumpStartFinal/merges\",\n      \"archive_url\": \"https://api.github.com/repos/johnpapa/PluralsightSpaJumpStartFinal/{archive_format}{/ref}\",\n      \"downloads_url\": \"https://api.github.com/repos/johnpapa/PluralsightSpaJumpStartFinal/downloads\",\n      \"issues_url\": \"https://api.github.com/repos/johnpapa/PluralsightSpaJumpStartFinal/issues{/number}\",\n      \"pulls_url\": \"https://api.github.com/repos/johnpapa/PluralsightSpaJumpStartFinal/pulls{/number}\",\n      \"milestones_url\": \"https://api.github.com/repos/johnpapa/PluralsightSpaJumpStartFinal/milestones{/number}\",\n      \"notifications_url\": \"https://api.github.com/repos/johnpapa/PluralsightSpaJumpStartFinal/notifications{?since,all,participating}\",\n      \"labels_url\": \"https://api.github.com/repos/johnpapa/PluralsightSpaJumpStartFinal/labels{/name}\",\n      \"releases_url\": \"https://api.github.com/repos/johnpapa/PluralsightSpaJumpStartFinal/releases{/id}\",\n      \"deployments_url\": \"https://api.github.com/repos/johnpapa/PluralsightSpaJumpStartFinal/deployments\",\n      \"created_at\": \"2013-03-08T16:33:51Z\",\n      \"updated_at\": \"2020-05-28T09:35:08Z\",\n      \"pushed_at\": \"2015-09-03T11:24:04Z\",\n      \"git_url\": \"git://github.com/johnpapa/PluralsightSpaJumpStartFinal.git\",\n      \"ssh_url\": \"git@github.com:johnpapa/PluralsightSpaJumpStartFinal.git\",\n      \"clone_url\": \"https://github.com/johnpapa/PluralsightSpaJumpStartFinal.git\",\n      \"svn_url\": \"https://github.com/johnpapa/PluralsightSpaJumpStartFinal\",\n      \"homepage\": null,\n      \"size\": 24392,\n      \"stargazers_count\": 133,\n      \"watchers_count\": 133,\n      \"language\": \"JavaScript\",\n      \"has_issues\": true,\n      \"has_projects\": true,\n      \"has_downloads\": true,\n      \"has_wiki\": true,\n      \"has_pages\": false,\n      \"forks_count\": 1430,\n      \"mirror_url\": null,\n      \"archived\": false,\n      \"disabled\": false,\n      \"open_issues_count\": 2,\n      \"license\": null,\n      \"forks\": 1430,\n      \"open_issues\": 2,\n      \"watchers\": 133,\n      \"default_branch\": \"master\",\n      \"score\": 1.0\n    }\n  ]\n}";
            _mockWebClient.Setup(x => x.GetHttpStringResponse("https://api.github.com/search/repositories?q=plural&page=1&per_page=1")).Returns(jsonRepositories);
            _mockConverter.Setup(x => x.DeserializeObject<GitHubRepository>(jsonRepositories))
                .Returns(new GitHubRepository())
                .Verifiable();
            _mockWebClient.Verify();
        }

        // Behavioral testing to verifies deserialized commit history
        [Test]
        public void Returns_DeserializedCommitHistory()
        {
            const string jsonCommitHistory = "[\n  {\n    \"sha\": \"8e52ebee844d94c504e435f8578d8fc81596deb3\",\n    \"node_id\": \"MDY6Q29tbWl0ODY1NDk3NTo4ZTUyZWJlZTg0NGQ5NGM1MDRlNDM1Zjg1NzhkOGZjODE1OTZkZWIz\",\n    \"commit\": {\n      \"author\": {\n        \"name\": \"John Papa\",\n        \"email\": \"john@johnpapa.net\",\n        \"date\": \"2013-07-20T03:27:40Z\"\n      },\n      \"committer\": {\n        \"name\": \"John Papa\",\n        \"email\": \"john@johnpapa.net\",\n        \"date\": \"2013-07-20T03:27:40Z\"\n      },\n      \"message\": \"craig\",\n      \"tree\": {\n        \"sha\": \"56d95d788fbe3847ceaa5c0a51b90381638d0f76\",\n        \"url\": \"https://api.github.com/repos/johnpapa/PluralsightSpaJumpStartFinal/git/trees/56d95d788fbe3847ceaa5c0a51b90381638d0f76\"\n      },\n      \"url\": \"https://api.github.com/repos/johnpapa/PluralsightSpaJumpStartFinal/git/commits/8e52ebee844d94c504e435f8578d8fc81596deb3\",\n      \"comment_count\": 0,\n      \"verification\": {\n        \"verified\": false,\n        \"reason\": \"unsigned\",\n        \"signature\": null,\n        \"payload\": null\n      }\n    },\n    \"url\": \"https://api.github.com/repos/johnpapa/PluralsightSpaJumpStartFinal/commits/8e52ebee844d94c504e435f8578d8fc81596deb3\",\n    \"html_url\": \"https://github.com/johnpapa/PluralsightSpaJumpStartFinal/commit/8e52ebee844d94c504e435f8578d8fc81596deb3\",\n    \"comments_url\": \"https://api.github.com/repos/johnpapa/PluralsightSpaJumpStartFinal/commits/8e52ebee844d94c504e435f8578d8fc81596deb3/comments\",\n    \"author\": {\n      \"login\": \"johnpapa\",\n      \"id\": 1202528,\n      \"node_id\": \"MDQ6VXNlcjEyMDI1Mjg=\",\n      \"avatar_url\": \"https://avatars2.githubusercontent.com/u/1202528?v=4\",\n      \"gravatar_id\": \"\",\n      \"url\": \"https://api.github.com/users/johnpapa\",\n      \"html_url\": \"https://github.com/johnpapa\",\n      \"followers_url\": \"https://api.github.com/users/johnpapa/followers\",\n      \"following_url\": \"https://api.github.com/users/johnpapa/following{/other_user}\",\n      \"gists_url\": \"https://api.github.com/users/johnpapa/gists{/gist_id}\",\n      \"starred_url\": \"https://api.github.com/users/johnpapa/starred{/owner}{/repo}\",\n      \"subscriptions_url\": \"https://api.github.com/users/johnpapa/subscriptions\",\n      \"organizations_url\": \"https://api.github.com/users/johnpapa/orgs\",\n      \"repos_url\": \"https://api.github.com/users/johnpapa/repos\",\n      \"events_url\": \"https://api.github.com/users/johnpapa/events{/privacy}\",\n      \"received_events_url\": \"https://api.github.com/users/johnpapa/received_events\",\n      \"type\": \"User\",\n      \"site_admin\": false\n    },\n    \"committer\": {\n      \"login\": \"johnpapa\",\n      \"id\": 1202528,\n      \"node_id\": \"MDQ6VXNlcjEyMDI1Mjg=\",\n      \"avatar_url\": \"https://avatars2.githubusercontent.com/u/1202528?v=4\",\n      \"gravatar_id\": \"\",\n      \"url\": \"https://api.github.com/users/johnpapa\",\n      \"html_url\": \"https://github.com/johnpapa\",\n      \"followers_url\": \"https://api.github.com/users/johnpapa/followers\",\n      \"following_url\": \"https://api.github.com/users/johnpapa/following{/other_user}\",\n      \"gists_url\": \"https://api.github.com/users/johnpapa/gists{/gist_id}\",\n      \"starred_url\": \"https://api.github.com/users/johnpapa/starred{/owner}{/repo}\",\n      \"subscriptions_url\": \"https://api.github.com/users/johnpapa/subscriptions\",\n      \"organizations_url\": \"https://api.github.com/users/johnpapa/orgs\",\n      \"repos_url\": \"https://api.github.com/users/johnpapa/repos\",\n      \"events_url\": \"https://api.github.com/users/johnpapa/events{/privacy}\",\n      \"received_events_url\": \"https://api.github.com/users/johnpapa/received_events\",\n      \"type\": \"User\",\n      \"site_admin\": false\n    },\n    \"parents\": [\n      {\n        \"sha\": \"52a7e476a925f0e4f3fa0bf1e5e7cbeea6ccb4da\",\n        \"url\": \"https://api.github.com/repos/johnpapa/PluralsightSpaJumpStartFinal/commits/52a7e476a925f0e4f3fa0bf1e5e7cbeea6ccb4da\",\n        \"html_url\": \"https://github.com/johnpapa/PluralsightSpaJumpStartFinal/commit/52a7e476a925f0e4f3fa0bf1e5e7cbeea6ccb4da\"\n      }\n    ]\n  }\n]";
            _mockWebClient.Setup(x => x.GetHttpStringResponse("https://api.github.com/repos/johnpapa/PluralsightSpaJumpStartFinal/commits?page=1&per_page=1")).Returns(jsonCommitHistory);
            _mockConverter.Setup(x => x.DeserializeObject<GitHubCommitHistoryCollection>(jsonCommitHistory))
                .Returns(new GitHubCommitHistoryCollection())
                .Verifiable();
            _mockWebClient.Verify();
        }
    }
}
